# How to Get Push Notification Keys (Frontend Guide)

## Overview

The `keys` (p256dh and auth) are automatically generated by the browser when a user subscribes to push notifications. You need to extract them from the browser's PushSubscription object.

## Step-by-Step Process

### 1. Get VAPID Public Key from Strapi

First, fetch the VAPID public key from your Strapi backend:

```javascript
// Get VAPID public key
// Use environment variable or detect from current hostname
const STRAPI_URL = process.env.NEXT_PUBLIC_STRAPI_URL || 
                   process.env.STRAPI_URL || 
                   `${window.location.protocol}//${window.location.hostname}:1337`;

const response = await fetch(`${STRAPI_URL}/api/push-subscriptions/public-key`);
const { data } = await response.json();
const vapidPublicKey = data.publicKey;

// Convert base64 URL to Uint8Array
function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding)
    .replace(/\-/g, '+')
    .replace(/_/g, '/');

  const rawData = window.atob(base64);
  const outputArray = new Uint8Array(rawData.length);

  for (let i = 0; i < rawData.length; ++i) {
    outputArray[i] = rawData.charCodeAt(i);
  }
  return outputArray;
}

const applicationServerKey = urlBase64ToUint8Array(vapidPublicKey);
```

### 2. Register Service Worker

```javascript
// Register service worker
const registration = await navigator.serviceWorker.register('/sw.js');
await navigator.serviceWorker.ready;
```

### 3. Subscribe to Push Notifications

```javascript
// Request notification permission
const permission = await Notification.requestPermission();

if (permission === 'granted') {
  // Subscribe to push notifications
  const subscription = await registration.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: applicationServerKey
  });

  // Extract keys from subscription
  const keys = {
    p256dh: arrayBufferToBase64(subscription.getKey('p256dh')),
    auth: arrayBufferToBase64(subscription.getKey('auth'))
  };

  // Helper function to convert ArrayBuffer to base64
  function arrayBufferToBase64(buffer) {
    const bytes = new Uint8Array(buffer);
    let binary = '';
    for (let i = 0; i < bytes.byteLength; i++) {
      binary += String.fromCharCode(bytes[i]);
    }
    return window.btoa(binary);
  }

  // Now you have:
  // - subscription.endpoint (the endpoint URL)
  // - keys.p256dh (public encryption key)
  // - keys.auth (authentication secret)
}
```

### 4. Send Subscription to Strapi

```javascript
// Send subscription to Strapi
const subscriptionData = {
  endpoint: subscription.endpoint,
  keys: {
    p256dh: keys.p256dh,
    auth: keys.auth
  },
  device: navigator.userAgent.includes('Mobile') ? 'mobile' : 'desktop',
  userAgent: navigator.userAgent
};

const response = await fetch(`${STRAPI_URL}/api/push-subscriptions`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    data: subscriptionData
  })
});

const result = await response.json();
console.log('Subscription saved:', result);
```

## Complete Example (React/Next.js)

```javascript
'use client';

import { useState, useEffect } from 'react';

export default function PushNotificationButton() {
  const [isSubscribed, setIsSubscribed] = useState(false);
  const [subscription, setSubscription] = useState(null);

  useEffect(() => {
    checkSubscription();
  }, []);

  async function checkSubscription() {
    if ('serviceWorker' in navigator && 'PushManager' in window) {
      const registration = await navigator.serviceWorker.ready;
      const sub = await registration.pushManager.getSubscription();
      setSubscription(sub);
      setIsSubscribed(!!sub);
    }
  }

  async function subscribeToPush() {
    try {
      // 1. Get VAPID public key from Strapi
      // Use utility function or environment variable
      const STRAPI_URL = process.env.NEXT_PUBLIC_STRAPI_URL || 
                         process.env.STRAPI_URL || 
                         `${window.location.protocol}//${window.location.hostname}:1337`;

      const keyResponse = await fetch(`${STRAPI_URL}/api/push-subscriptions/public-key`);
      const { data } = await keyResponse.json();
      const vapidPublicKey = data.publicKey;

      // 2. Convert VAPID key
      function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding)
          .replace(/\-/g, '+')
          .replace(/_/g, '/');
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
      }

      const applicationServerKey = urlBase64ToUint8Array(vapidPublicKey);

      // 3. Register service worker
      const registration = await navigator.serviceWorker.register('/sw.js');
      await navigator.serviceWorker.ready;

      // 4. Request permission
      const permission = await Notification.requestPermission();
      if (permission !== 'granted') {
        alert('Notification permission denied');
        return;
      }

      // 5. Subscribe
      const pushSubscription = await registration.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: applicationServerKey
      });

      // 6. Extract keys
      function arrayBufferToBase64(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = '';
        for (let i = 0; i < bytes.byteLength; i++) {
          binary += String.fromCharCode(bytes[i]);
        }
        return window.btoa(binary);
      }

      const keys = {
        p256dh: arrayBufferToBase64(pushSubscription.getKey('p256dh')),
        auth: arrayBufferToBase64(pushSubscription.getKey('auth'))
      };

      // 7. Send to Strapi
      const response = await fetch(`${STRAPI_URL}/api/push-subscriptions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          data: {
            endpoint: pushSubscription.endpoint,
            keys: keys,
            device: navigator.userAgent.includes('Mobile') ? 'mobile' : 'desktop',
            userAgent: navigator.userAgent
          }
        })
      });

      if (response.ok) {
        setIsSubscribed(true);
        setSubscription(pushSubscription);
        alert('Successfully subscribed to push notifications!');
      }
    } catch (error) {
      console.error('Error subscribing to push:', error);
      alert('Failed to subscribe to push notifications');
    }
  }

  async function unsubscribeFromPush() {
    try {
      if (subscription) {
        await subscription.unsubscribe();
        setIsSubscribed(false);
        setSubscription(null);
        alert('Unsubscribed from push notifications');
      }
    } catch (error) {
      console.error('Error unsubscribing:', error);
    }
  }

  return (
    <div>
      {!isSubscribed ? (
        <button onClick={subscribeToPush}>
          Enable Push Notifications
        </button>
      ) : (
        <button onClick={unsubscribeFromPush}>
          Disable Push Notifications
        </button>
      )}
    </div>
  );
}
```

## Key Points

1. **Keys are generated by the browser** - You don't create them manually
2. **Extract from PushSubscription object** - Use `subscription.getKey('p256dh')` and `subscription.getKey('auth')`
3. **Convert to base64** - The keys are ArrayBuffers that need to be converted to base64 strings
4. **Send to Strapi** - Store the endpoint and keys in your Strapi database

## Testing

1. Open your frontend app in a browser
2. Click "Enable Push Notifications"
3. Grant permission when prompted
4. Check Strapi admin - you should see a new Push Subscription entry with:
   - `endpoint`: The push service URL
   - `keys`: JSON object with `p256dh` and `auth`
   - `device`: "mobile" or "desktop"
   - `userAgent`: Browser user agent string

The keys are automatically extracted and sent to Strapi - you never need to manually enter them!

